<div>
  <header data-orb-qa-id="agent-policy#add">
    <xng-breadcrumb class="orb-breadcrumb"
                    data-orb-qa-id="breadcrumb">
      <ng-container
        *xngBreadcrumbItem="let breadcrumb; let info = info; let first = first">
        <ng-container [ngClass]="{'my_class': first === ''}">{{ breadcrumb }}</ng-container>
      </ng-container>
    </xng-breadcrumb>
    <h4>{{ isEdit ? 'Edit Agent Policy' : 'Create Agent Policy'}}</h4>
  </header>
  <div class="d-flex row" *ngIf="!isLoading">
    <div class="d-flex col-12 mt-5">
      <form [formGroup]="backendFormGroup" (ngSubmit)="onFormSubmit()">
        <nb-form-field>
          <div>
            <label class="font-weight-bold">Tap</label>
            <span class="required">*</span>
          </div>
          <nb-select size="medium"
                     (selectedChange)="onBackendSelected($event)"
                     fullWidth="true"
                     formControlName="backend"
                     appearance="filled"
                     placeholder="Select backend type"
                     data-orb-qa-id="backend">
            <nb-option *ngFor="let entry of availableBackends | keyvalue"
                       [value]="entry.key">{{ entry.key | titlecase }}</nb-option>
          </nb-select>
        </nb-form-field>
      </form>
      <hr/>
      <form [formGroup]="tapFormGroup" (ngSubmit)="onFormSubmit()">
        <nb-form-field>
          <div>
            <label class="font-weight-bold">Tap</label>
            <span class="required">*</span>
          </div>
          <nb-select size="medium"
                     (selectedChange)="onTapSelected($event)"
                     fullWidth="true"
                     formControlName="backend"
                     appearance="filled"
                     placeholder="Select backend type"
                     data-orb-qa-id="backend">
            <nb-option *ngFor="let entry of availableTaps | keyvalue"
                       [value]="entry.key">{{ entry.key | titlecase }}</nb-option>
          </nb-select>
        </nb-form-field>
      </form>
      <hr/>
      <form [formGroup]="handlersFormGroup" (ngSubmit)="onFormSubmit()">
        <nb-form-field>
          <div>
            <label class="font-weight-bold">Tap</label>
            <span class="required">*</span>
          </div>
          <nb-select size="medium"
                     (selectedChange)="onHandlerSelected($event)"
                     fullWidth="true"
                     formControlName="backend"
                     appearance="filled"
                     placeholder="Select backend type"
                     data-orb-qa-id="backend">
            <nb-option *ngFor="let entry of availableHandlers | keyvalue"
                       [value]="entry.key">{{ entry.key | titlecase }}</nb-option>
          </nb-select>
        </nb-form-field>
        <!-- wip -->
        <!-- TODO dynamic form based on backend atenÃ§aum creuzeback -->
        <nb-form-field *ngFor="let control of selectedSinkSetting;let i = index">
          <div>
            <label class="font-weight-bold">{{control.label}}</label>
          </div>
          <div [ngSwitch]="control.input">
            <input *ngSwitchCase="'text'"
                   [autofocus]="i == 0"
                   nbInput
                   [type]="control.type"
                   fullWidth="true"
                   fieldSize="medium"
                   [formControlName]="control.prop"
                   [attr.data-orb-qa-id]="control.prop">
            <input *ngSwitchCase="'number'"
                   [autofocus]="i == 0"
                   nbInput
                   [type]="control.type"
                   fullWidth="true"
                   fieldSize="medium"
                   [min]="control.min"
                   [max]="control.max"
                   [step]="control.step"
                   [formControlName]="control.prop"
                   [attr.data-orb-qa-id]="control.prop">
            <nb-select *ngSwitchCase="'select'"
                       appearance="filled"
                       size="medium"
                       fullWidth="true"
                       formControlName="backend"
                       placeholder="Select backend type"
                       data-orb-qa-id="backend">
              <nb-option *ngFor="let type of control.options"
                         [value]="type"
                         [attr.data-orb-qa-id]="type">{{ type }}</nb-option>
            </nb-select>

          </div>
          <hr/>
        </nb-form-field>
        <!-- end of dynamic form based on discovery -->
        <div class="d-flex justify-content-end" *ngIf="backendFormGroup">
          <button
            nbButton
            ghost
            status="primary"
            nbStepperPrevious
            data-orb-qa-id="previous">Back
          </button>
          <button class="next-button"
                  nbButton
                  shape="round"
                  status="primary"
                  (click)="onFormSubmit()"
                  type="submit"
                  data-orb-qa-id="next">Save
          </button>
        </div>

    </div>
  </div>
