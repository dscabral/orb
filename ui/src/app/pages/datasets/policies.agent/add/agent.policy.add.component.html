<div>
  <header data-orb-qa-id="agent-policy#add">
    <xng-breadcrumb class="orb-breadcrumb"
                    data-orb-qa-id="breadcrumb">
      <ng-container
        *xngBreadcrumbItem="let breadcrumb; let info = info; let first = first">
        <ng-container [ngClass]="{'my_class': first === ''}">{{ breadcrumb }}</ng-container>
      </ng-container>
    </xng-breadcrumb>
    <h4>{{ isEdit ? 'Edit Agent Policy' : 'Create Agent Policy'}}</h4>
  </header>
  <div *ngIf="!isLoading" class="d-flex row">
    <div class="d-flex col-12 mt-5">
      <nb-stepper class="stepper w-100 ml-5"
                  disableStepNavigation
                  orientation="vertical">
        <nb-step [label]="firstStepTemplate"
                 [stepControl]="detailsFormGroup"
                 data-orb-qa-id="step_1">
          <ng-template #firstStepTemplate>
            <div class="step-label d-flex flex-column">
              <strong>Agent Policy Details</strong>
              <p>Provide a name, a description summary and a supported backend for the Agent Policy</p>
            </div>
          </ng-template>
          <form (ngSubmit)="onFormSubmit()" [formGroup]="detailsFormGroup">
            <nb-form-field>
              <div class="d-flex flex-column">
                <div>
                  <label class="font-weight-bold" for="name">Name Label</label>
                  <span class="required">*</span>
                </div>
                <input autofocus
                       data-orb-qa-id="name"
                       fieldSize="medium"
                       formControlName="name"
                       fullWidth="true"
                       id="name"
                       nbInput/>
              </div>
            </nb-form-field>
            <nb-form-field>
              <div>
                <label class="font-weight-bold" for="description">Policy Description</label>
              </div>
              <input data-orb-qa-id="description"
                     fieldSize="medium"
                     formControlName="description"
                     fullWidth="true"
                     id="description"
                     nbInput/>
            </nb-form-field>
            <hr/>
            <!-- Backend Selector -->
            <nb-form-field>
              <div>
                <label class="font-weight-bold" for="backend">Backend</label>
                <span class="required">*</span>
              </div>
              <nb-select (selectedChange)="onBackendSelected($event)"
                         appearance="filled"
                         data-orb-qa-id="backend"
                         formControlName="backend"
                         fullWidth="true"
                         id="backend"
                         placeholder="Select backend type"
                         size="medium">
                <nb-option *ngFor="let entry of availableBackends; index as i"
                           [value]="i">{{ entry.backend | titlecase }}</nb-option>
              </nb-select>
            </nb-form-field>
          </form>
          <hr/>
          <div class="d-flex justify-content-end">
            <button
              (click)="goBack()"
              data-orb-qa-id="cancel"
              ghost
              nbButton
              status="primary"
              type="button">Cancel
            </button>
            <button [disabled]="!detailsFormGroup?.valid"
                    class="next-button"
                    data-orb-qa-id="next"
                    nbButton
                    nbStepperNext
                    shape="round"
                    status="primary"
                    type="submit">Next
            </button>
          </div>
        </nb-step>
        <nb-step [label]="secondStepTemplate"
                 [stepControl]="tapFormGroup"
                 data-orb-qa-id="step_2">
          <ng-template #secondStepTemplate>
            <div class="step-label d-flex flex-column">
              <strong>Tap Setup</strong>
              <p>Create and configure tap</p>
            </div>
          </ng-template>
          <div *ngIf="availableTaps && availableInputs">
            <form (ngSubmit)="onFormSubmit()" [formGroup]="tapFormGroup">
              <!-- Tap selector -->
              <nb-form-field>
                <div>
                  <label class="font-weight-bold">Tap</label>
                  <span class="required">*</span>
                </div>
                <nb-select (selectedChange)="onTapSelected($event)"
                           appearance="filled"
                           data-orb-qa-id="taps"
                           formControlName="selected_tap"
                           fullWidth="true"
                           nbInput
                           placeholder="Select Tap"
                           required="true"
                           size="medium">
                  <nb-option *ngFor="let option of availableTaps; index as i"
                             [attr.data-orb-qa-id]="option.key"
                             [value]="i">{{ option.tap }}</nb-option>
                </nb-select>
              </nb-form-field>
              <!-- Input selector -->
              <nb-form-field [hidden]="!tap">
                <div>
                  <label class="font-weight-bold">Input</label>
                  <span class="required">*</span>
                </div>
                <nb-select (selectedChange)="onInputSelected($event)"
                           [attr.data-orb-qa-id]="input"
                           appearance="filled"
                           formControlName="input_type"
                           fullWidth="true"
                           id="input_type"
                           nbInput
                           size="medium">
                  <nb-option *ngFor="let option of availableInputs | keyvalue"
                             [attr.data-orb-qa-id]="option.key"
                             [value]="option.key">{{ option.key | titlecase }}</nb-option>
                </nb-select>
              </nb-form-field>
            </form>
          </div>
          <div *ngIf="inputFormGroup && input">
            <!-- Dynamic Input Form -->
            <form (ngSubmit)="onFormSubmit()" [formGroup]="inputFormGroup">
              <nb-form-field *ngFor="let control of input['config'] | keyvalue; index as i;">
                <div>
                  <label class="font-weight-bold">{{control.value.title}}</label>
                </div>
                <div [ngSwitch]="control.value.input">
                  <input *ngSwitchCase="'text'"
                         [attr.data-orb-qa-id]="control.value.name"
                         [autofocus]="i == 0"
                         [formControlName]="control.value.name"
                         [type]="control.value.type"
                         fieldSize="medium"
                         fullWidth="true"
                         nbInput>
                  <input *ngSwitchCase="'number'"
                         [attr.data-orb-qa-id]="control.value.name"
                         [autofocus]="i == 0"
                         [formControlName]="control.value.name"
                         [max]="control.value.max"
                         [min]="control.value.min"
                         [step]="control.value.step"
                         [type]="control.value.type"
                         fieldSize="medium"
                         fullWidth="true"
                         nbInput>
                  <nb-select *ngSwitchCase="'select'"
                             [attr.data-orb-qa-id]="control.value.name"
                             [formControlName]="control.value.name"
                             [id]="control.value.name"
                             appearance="filled"
                             fullWidth="true"
                             nbInput
                             size="medium">{{ control.value.name + "-" + control.value.options }}
                    <nb-option *ngFor="let option of control.value.options"
                               [attr.data-orb-qa-id]="option"
                               [value]="option">{{ option }}</nb-option>
                  </nb-select>
                </div>
                <hr/>
              </nb-form-field>
            </form>
          </div>
          <div class="d-flex justify-content-end">
            <button
              (click)="goBack()"
              data-orb-qa-id="cancel"
              ghost
              nbButton
              status="primary"
              type="button">Cancel
            </button>
            <button [disabled]="!tapFormGroup?.valid"
                    class="next-button"
                    data-orb-qa-id="next"
                    nbButton
                    nbStepperNext
                    shape="round"
                    status="primary"
                    type="submit">Next
            </button>
          </div>
        </nb-step>
        <nb-step [label]="thirdStepTemplate"
                 [stepControl]="handlerFormGroup"
                 data-orb-qa-id="step_2">
          <ng-template #thirdStepTemplate>
            <div class="step-label d-flex flex-column">
              <strong>Add Data Handlers</strong>
              <p>Setup any number of handlers</p>
            </div>
          </ng-template>
          <div *ngIf="handlerFormGroup">
            <form [formGroup]="handlerFormGroup">
              <!-- Added Handlers List -->
              <div class="d-flex">
                <mat-chip-list data-orb-qa-id="handlers-list">
                  <mat-chip
                    *ngFor="let handler of handlers; index as i"
                    [attr.data-orb-qa-id]="'handler_' + i"
                    [style.background-color]="handler.keys()[0] | tagchipcolor"
                    class="orb-selected-handler ">
                    {{ handler }}
                    <nb-icon (click)="onHandlerRemoved(handler)"
                             class="ml-1"
                             icon="close-outline"
                             size="12"></nb-icon>
                  </mat-chip>
                </mat-chip-list>
              </div>
              <hr/>
              <nb-form-field>
                <div>
                  <label class="font-weight-bold">Handler</label>
                  <span class="required">*</span>
                </div>
                <!-- Select a Handler -->
                <nb-select (selectedChange)="onHandlerSelected($event)"
                           appearance="filled"
                           data-orb-qa-id="sink_selector"
                           formControlName="selected_handler"
                           fullWidth="true"
                           placeholder="Sink Name"
                           size="medium"
                >
                  <nb-option *ngFor="let handler of availableHandlers | keyvalue"
                             [attr.data-orb-qa-id]="'available_handler: '+handler.key" [id]="handler.key"
                             [value]="handler.key">{{ handler.key | titlecase }}</nb-option>
                </nb-select>
              </nb-form-field>
              <button (click)="onHandlerAdded()"
                      [disabled]="(handlerFormGroup.controls['selected_handler'].value === '')"
                      data-orb-qa-id="addHandler"
                      ghost
                      nbButton>
                <nb-icon icon="plus-outline"
                         size="14"
                         status="primary"
                         style="color: #df316f;">
                </nb-icon>
              </button>
              <hr/>
              <!--Dynamic Handler Config-->
              <div *ngIf="liveHandler">
                <nb-form-field *ngFor="let control of tap['config'] | keyvalue; let i = index">
                  <div>
                    <label class="font-weight-bold">{{control.value.title}}</label>
                  </div>
                  <div [ngSwitch]="control.value.input">
                    <input *ngSwitchCase="'text'"
                           [attr.data-orb-qa-id]="control.value.name"
                           [autofocus]="i == 0"
                           [formControlName]="control.value.name"
                           [type]="control.value.type"
                           fieldSize="medium"
                           fullWidth="true"
                           nbInput>
                    <input *ngSwitchCase="'number'"
                           [attr.data-orb-qa-id]="control.value.name"
                           [autofocus]="i == 0"
                           [formControlName]="control.value.name"
                           [max]="control.value.max"
                           [min]="control.value.min"
                           [step]="control.value.step"
                           [type]="control.value.type"
                           fieldSize="medium"
                           fullWidth="true"
                           nbInput>
                    <nb-select (selectedChange)="onInputSelected($event)"
                               *ngSwitchCase="'select'"
                               [attr.data-orb-qa-id]="control.value.name"
                               [formControlName]="control.value.name"
                               [id]="control.value.name"
                               appearance="filled"
                               fullWidth="true"
                               nbInput
                               size="medium">{{ control.value.name + "-" + control.value.options }}
                      <nb-option *ngFor="let option of control.value.options"
                                 [attr.data-orb-qa-id]="option"
                                 [value]="option">{{ option }}</nb-option>
                    </nb-select>
                  </div>
                  <hr/>
                </nb-form-field>
              </div>
              <div *ngIf="handlerFormGroup" class="d-flex justify-content-start"
                   style="padding-left: 35%;">
                <button
                  data-orb-qa-id="back"
                  ghost
                  nbButton
                  nbStepperPrevious
                  status="primary">
                  Back
                </button>
                <button [disabled]="handlers.length === 0"
                        class="next-button"
                        data-orb-qa-id="next"
                        nbButton
                        nbStepperNext
                        shape="round"
                        status="primary"
                        type="submit">
                  Next
                </button>
              </div>
            </form>
          </div>
        </nb-step>
      </nb-stepper>
    </div>
  </div>
</div>