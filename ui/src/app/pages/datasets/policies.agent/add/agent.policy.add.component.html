<div>
  <header data-orb-qa-id="agent-policy#add">
    <xng-breadcrumb class="orb-breadcrumb"
                    data-orb-qa-id="breadcrumb">
      <ng-container
        *xngBreadcrumbItem="let breadcrumb; let info = info; let first = first">
        <ng-container [ngClass]="{'my_class': first === ''}">{{ breadcrumb }}</ng-container>
      </ng-container>
    </xng-breadcrumb>
    <h4>{{ isEdit ? 'Edit Agent Policy' : 'Create Agent Policy'}}</h4>
  </header>
  <div *ngIf="!isLoading" class="row">
    <div class="col-6">
      <form (ngSubmit)="onFormSubmit()" [formGroup]="detailsFormGroup">
        <nb-form-field>
          <div class="d-flex flex-column">
            <div>
              <label class="font-weight-bold" for="name">Name Label</label>
              <span class="required">*</span>
            </div>
            <input autofocus
                   data-orb-qa-id="name"
                   fieldSize="medium"
                   formControlName="name"
                   fullWidth="true"
                   id="name"
                   nbInput/>
          </div>
        </nb-form-field>
        <nb-form-field>
          <div>
            <label class="font-weight-bold" for="description">Policy Description</label>
          </div>
          <input data-orb-qa-id="description"
                 fieldSize="medium"
                 formControlName="description"
                 fullWidth="true"
                 id="description"
                 nbInput/>
        </nb-form-field>
        <hr/>
        <nb-form-field>
          <div>
            <label class="font-weight-bold" for="backend">Backend</label>
            <span class="required">*</span>
          </div>
          <nb-select (selectedChange)="onBackendSelected($event)"
                     appearance="filled"
                     data-orb-qa-id="backend"
                     formControlName="backend"
                     fullWidth="true"
                     id="backend"
                     placeholder="Select backend type"
                     size="medium">
            <nb-option *ngFor="let entry of availableBackends | keyvalue"
                       [value]="entry.key">{{ entry.key | titlecase }}</nb-option>
          </nb-select>
        </nb-form-field>
      </form>
      <hr/>
      <!-- wip -->
      <!-- once pktvisor selected as backend, start policies -->
      <!-- a form for each aspect [taps -> input, then handlers] -->
      <!-- TODO achieve full dynamic - super similar formfields here-->
      <div *ngIf="backend">
        <form
          (ngSubmit)="onFormSubmit()"
          *ngFor="let formPiece of backendConfigForms | keyvalue; index as i;"
          [formGroup]="formPiece.value">

          <!-- tap form -->
          <!-- select tap -->
          <div *ngIf="formPiece.key === 'taps'" [formGroup]="backendConfigForms['taps']">
            <nb-form-field>
              <div>
                <label class="font-weight-bold">Tap</label>
                <span class="required">*</span>
              </div>
              <nb-select (selectedChange)="onTapSelected($event)"
                         [attr.data-orb-qa-id]="formPiece.key"
                         [formControlName]="formPiece.key"
                         appearance="filled"
                         fullWidth="true"
                         nbInput="{{ formPiece.key }}"
                         placeholder="Select Tap"
                         required="true"
                         size="medium">
                <nb-option *ngFor="let option of backend[formPiece.key] | keyvalue"
                           [attr.data-orb-qa-id]="option.key"
                           [value]="option.key">{{ option.key }}</nb-option>
              </nb-select>
            </nb-form-field>
            <div *ngIf="tap">
              <nb-form-field *ngFor="let control of tap['config'] | keyvalue; let i = index"
                             [formGroup]="formPiece.value">
                <div>
                  <label class="font-weight-bold">{{control.value.title}}</label>
                </div>
                <div [ngSwitch]="control.value.input" [formGroup]="backendConfigForms['taps']">
                  <input *ngSwitchCase="'text'"
                         [attr.data-orb-qa-id]="control.value.name"
                         [autofocus]="i == 0"
                         [formControlName]="control.value.name"
                         [type]="control.value.type"
                         fieldSize="medium"
                         fullWidth="true"
                         nbInput>
                  <input *ngSwitchCase="'number'"
                         [attr.data-orb-qa-id]="control.value.name"
                         [autofocus]="i == 0"
                         [formControlName]="control.value.name"
                         [max]="control.value.max"
                         [min]="control.value.min"
                         [step]="control.value.step"
                         [type]="control.value.type"
                         fieldSize="medium"
                         fullWidth="true"
                         nbInput>
                  <nb-select (selectedChange)="onInputSelected($event)"
                             *ngSwitchCase="'select'"
                             [attr.data-orb-qa-id]="formPiece.key"
                             [formControlName]="formPiece.key"
                             [id]="formPiece.key"
                             appearance="filled"
                             fullWidth="true"
                             nbInput="{{ formPiece.key }}"
                             size="medium">{{ formPiece.key + " " + control.value.options }}
                    <nb-option *ngFor="let option of control.value.options"
                               [attr.data-orb-qa-id]="option"
                               [value]="option">{{ option }}</nb-option>
                  </nb-select>
                </div>
                <hr/>
              </nb-form-field>
            </div>
          </div>

          <!-- input form -->
          <!-- select input -->
          <div *ngIf="input && formPiece.key === 'inputs'" [formGroup]="backendConfigForms['inputs']">
            <nb-form-field *ngFor="let control of input['config'] | keyvalue; let i = index"
                           [formGroup]="formPiece.value">
              <div>
                <label class="font-weight-bold">{{control.value.title}}</label>
              </div>
              <div [ngSwitch]="control.value.input">
                <nb-select *ngSwitchCase="'select'"
                           [attr.data-orb-qa-id]="formPiece.key"
                           [formControlName]="formPiece.key"
                           [id]="formPiece.key"
                           appearance="filled"
                           fullWidth="true"
                           nbInput="{{ formPiece.key }}"
                           size="medium">{{ formPiece.key + " " + control.value.options }}
                  <nb-option *ngFor="let option of control.value.options"
                             [attr.data-orb-qa-id]="option"
                             [value]="option">{{ option }}</nb-option>
                </nb-select>
                <input *ngSwitchCase="'text'"
                       [attr.data-orb-qa-id]="control.value.name"
                       [autofocus]="i == 0"
                       [formControlName]="control.value.name"
                       [type]="control.value.type"
                       fieldSize="medium"
                       fullWidth="true"
                       nbInput>
                <input *ngSwitchCase="'number'"
                       [attr.data-orb-qa-id]="control.value.name"
                       [autofocus]="i == 0"
                       [formControlName]="control.value.name"
                       [max]="control.value.max"
                       [min]="control.value.min"
                       [step]="control.value.step"
                       [type]="control.value.type"
                       fieldSize="medium"
                       fullWidth="true"
                       nbInput>
              </div>
              <hr/>
            </nb-form-field>
          </div>
        </form>
      </div>
      <!-- end of dynamic form based on discovery -->
      <div *ngIf="backendConfigForms" class="d-flex justify-content-end">
        <button
          data-orb-qa-id="previous"
          ghost
          nbButton
          status="primary">Back
        </button>
        <button (click)="onFormSubmit()"
                class="next-button"
                data-orb-qa-id="next"
                nbButton
                shape="round"
                status="primary"
                type="submit">Save
        </button>
      </div>

    </div>
  </div>
</div>