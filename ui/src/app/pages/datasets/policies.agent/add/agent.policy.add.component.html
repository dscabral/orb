<div>
  <header data-orb-qa-id="agent-policy#add">
    <xng-breadcrumb class="orb-breadcrumb"
                    data-orb-qa-id="breadcrumb">
      <ng-container
        *xngBreadcrumbItem="let breadcrumb; let info = info; let first = first">
        <ng-container [ngClass]="{'my_class': first === ''}">{{ breadcrumb }}</ng-container>
      </ng-container>
    </xng-breadcrumb>
    <h4>{{ isEdit ? 'Edit Agent Policy' : 'Create Agent Policy'}}</h4>
  </header>
  <div class="d-flex row" *ngIf="!isLoading">
    <div class="d-flex col-12 mt-5">
      <form [formGroup]="detailsFormGroup" (ngSubmit)="onFormSubmit()">
        <nb-form-field>
          <div class="d-flex flex-column">
            <div>
              <label for="name" class="font-weight-bold">Name Label</label>
              <span class="required">*</span>
            </div>
            <input nbInput
                   autofocus
                   fullWidth="true"
                   fieldSize="medium"
                   id="name"
                   formControlName="name"
                   data-orb-qa-id="name"/>
          </div>
        </nb-form-field>
        <nb-form-field>
          <div>
            <label for="description" class="font-weight-bold">Policy Description</label>
          </div>
          <input nbInput
                 fullWidth="true"
                 fieldSize="medium"
                 id="description"
                 formControlName="description"
                 data-orb-qa-id="description"/>
        </nb-form-field>
        <hr/>
        <nb-form-field>
          <div>
            <label for="backend" class="font-weight-bold">Backend</label>
            <span class="required">*</span>
          </div>
          <nb-select size="medium"
                     (selectedChange)="onBackendSelected($event)"
                     fullWidth="true"
                     id="backend"
                     formControlName="backend"
                     appearance="filled"
                     placeholder="Select backend type"
                     data-orb-qa-id="backend">
            <nb-option *ngFor="let entry of availableBackends | keyvalue"
                       [value]="entry.key">{{ entry.key | titlecase }}</nb-option>
          </nb-select>
        </nb-form-field>
      </form>
      <hr/>
      <!-- wip -->
      <!-- a form for each aspect [taps, handlers, input] -->
      <form
        *ngFor="let aspect of backend | keyvalue; index as i;"
        [formGroup]="backendConfigForms[aspect.value]"
        (ngSubmit)="onFormSubmit()"
      >
        <nb-select *ngIf="aspect.key!== 'handlers'"
                   appearance="filled"
                   size="medium"
                   fullWidth="true"
                   [formControlName]="aspect.key"
                   [placeholder]="'Select' + aspect.key + ''"
                   required="true"
                   [attr.data-orb-qa-id]="aspect.key">
          <nb-option *ngFor="let option of aspect.value | keyvalue"
                     [value]="option.key"
                     [attr.data-orb-qa-id]="option.key">{{ option.key }}</nb-option>
        </nb-select>
        <div *ngIf="backendConfigForms[aspect.key].controls[aspect.key].valid">
          <nb-form-field *ngFor="let control of aspect.value.config | keyvalue; let i = index">
            <div>
              <label class="font-weight-bold">{{control.value.title}}</label>
            </div>
            <div [ngSwitch]="control.value.input">
              <input *ngSwitchCase="'text'"
                     [autofocus]="i == 0"
                     nbInput
                     [type]="control.value.type"
                     fullWidth="true"
                     fieldSize="medium"
                     [formControlName]="control.value.prop"
                     [attr.data-orb-qa-id]="control.value.prop">
              <input *ngSwitchCase="'number'"
                     [autofocus]="i == 0"
                     nbInput
                     [type]="control.value.type"
                     fullWidth="true"
                     fieldSize="medium"
                     [min]="control.value.min"
                     [max]="control.value.max"
                     [step]="control.value.step"
                     [formControlName]="control.value.prop"
                     [attr.data-orb-qa-id]="control.value.prop">
              <nb-select *ngSwitchCase="'select'"
                         appearance="filled"
                         size="medium"
                         fullWidth="true"
                         formControlName="backend"
                         placeholder="Select backend type"
                         data-orb-qa-id="backend">
                <nb-option *ngFor="let type of control.value.options"
                           [value]="type"
                           [attr.data-orb-qa-id]="type">{{ type }}</nb-option>
              </nb-select>

            </div>
            <hr/>
          </nb-form-field>
        </div>
      </form>
      <!-- end of dynamic form based on discovery -->
      <div class="d-flex justify-content-end" *ngIf="backendConfigForms">
        <button
          nbButton
          ghost
          status="primary"
          nbStepperPrevious
          data-orb-qa-id="previous">Back
        </button>
        <button class="next-button"
                nbButton
                shape="round"
                status="primary"
                (click)="onFormSubmit()"
                type="submit"
                data-orb-qa-id="next">Save
        </button>
      </div>

    </div>
  </div>
